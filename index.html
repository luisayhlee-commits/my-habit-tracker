import React, { useState, useEffect, useRef } from 'react';
import { 
  Check, Calendar, Layout, ChevronLeft, ChevronRight, 
  Droplets, Footprints, Dumbbell, Sparkles, Moon, Dog, Trophy, Activity,
  TrendingUp, Plus, X, Edit2, Trash2, Sun, PartyPopper
} from 'lucide-react';

// --- 預設習慣清單 ---
const DEFAULT_HABITS = [
  { id: 'water', title: 'Waterllama', icon: 'Droplets', color: 'cyan', goalPerWeek: 5, unit: '天' },
  { id: 'steps', title: '日走 7000 步', icon: 'Footprints', color: 'orange', goalPerWeek: 7, unit: '步' },
  { id: 'juc', title: '啾C 課程', icon: 'Activity', color: 'pink', goalPerWeek: 3, unit: '次' },
  { id: 'stretch', title: '晚間拉筋', icon: 'Moon', color: 'indigo', goalPerWeek: 7, unit: '晚' },
  { id: 'weight', title: '重訓', icon: 'Dumbbell', color: 'emerald', goalPerWeek: 4, unit: '次' },
  { id: 'luna', title: 'Luna', icon: 'Dog', color: 'violet', goalPerWeek: 5, unit: '次' },
];

const ICONS = {
  Droplets: <Droplets className="w-5 h-5" />,
  Footprints: <Footprints className="w-5 h-5" />,
  Activity: <Activity className="w-5 h-5" />,
  Moon: <Moon className="w-5 h-5" />,
  Dumbbell: <Dumbbell className="w-5 h-5" />,
  Trophy: <Trophy className="w-5 h-5" />,
  Dog: <Dog className="w-5 h-5" />,
  Sparkles: <Sparkles className="w-5 h-5" />,
  Check: <Check className="w-5 h-5" />
};

const COLOR_THEMES = {
  cyan: { from: 'from-cyan-400', to: 'to-blue-500', text: 'text-cyan-500', bg: 'bg-cyan-500' },
  orange: { from: 'from-orange-400', to: 'to-red-500', text: 'text-orange-500', bg: 'bg-orange-500' },
  pink: { from: 'from-pink-400', to: 'to-rose-500', text: 'text-pink-500', bg: 'bg-pink-500' },
  indigo: { from: 'from-indigo-400', to: 'to-purple-500', text: 'text-indigo-500', bg: 'bg-indigo-500' },
  emerald: { from: 'from-emerald-400', to: 'to-green-500', text: 'text-emerald-500', bg: 'bg-emerald-500' },
  yellow: { from: 'from-yellow-400', to: 'to-amber-500', text: 'text-yellow-500', bg: 'bg-yellow-500' },
  violet: { from: 'from-violet-400', to: 'to-fuchsia-500', text: 'text-violet-500', bg: 'bg-violet-500' },
};

const getDateString = (date) => date.toISOString().split('T')[0];

const getWeekStart = (date) => {
  const d = new Date(date);
  const day = d.getDay();
  // 週一為起始
  const diff = d.getDate() - (day === 0 ? 6 : day - 1);
  d.setDate(diff);
  d.setHours(0,0,0,0);
  return d;
};

const getDaysInWeek = (startDate) => {
  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(startDate);
    d.setDate(d.getDate() + i);
    days.push(getDateString(d));
  }
  return days;
};

const calculateWeeklyProgress = (habitId, date, logs) => {
  const start = getWeekStart(date);
  const weekDays = getDaysInWeek(start);
  let count = 0;
  weekDays.forEach(d => {
    if (logs[`${habitId}-${d}`]) count++;
  });
  return count;
};

export default function App() {
  const [logs, setLogs] = useState({});
  const [habits, setHabits] = useState(DEFAULT_HABITS);
  const [currentDate, setCurrentDate] = useState(new Date());
  const [view, setView] = useState('daily');
  const [themeMode, setThemeMode] = useState('night');
  const [isEditing, setIsEditing] = useState(false);
  const [editingHabit, setEditingHabit] = useState(null);
  const [celebration, setCelebration] = useState(null);

  useEffect(() => {
    const savedLogs = localStorage.getItem('habit2026_logs');
    const savedHabits = localStorage.getItem('habit2026_list');
    if (savedLogs) setLogs(JSON.parse(savedLogs));
    if (savedHabits) setHabits(JSON.parse(savedHabits));
    const hour = new Date().getHours();
    setThemeMode(hour >= 6 && hour < 18 ? 'day' : 'night');
  }, []);

  useEffect(() => {
    localStorage.setItem('habit2026_logs', JSON.stringify(logs));
    localStorage.setItem('habit2026_list', JSON.stringify(habits));
  }, [logs, habits]);

  const triggerCelebration = () => {
    const messages = ["太棒了！", "持續前進！", "你做到了！", "好讚！", "太厲害了！"];
    setCelebration(messages[Math.floor(Math.random() * messages.length)]);
    setTimeout(() => setCelebration(null), 1500);
  };

  const toggleHabit = (habitId, dateStr) => {
    setLogs(prev => {
      const newLogs = { ...prev };
      const key = `${habitId}-${dateStr}`;
      if (newLogs[key]) {
        delete newLogs[key];
      } else {
        newLogs[key] = true;
        triggerCelebration();
      }
      return newLogs;
    });
  };

  const checkStatus = (habitId, dateStr) => !!logs[`${habitId}-${dateStr}`];

  const handleSaveHabit = (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const newHabit = {
      id: editingHabit?.id || `h-` + Date.now(),
      title: formData.get('title'),
      goalPerWeek: parseInt(formData.get('goalPerWeek')),
      unit: formData.get('unit'),
      icon: editingHabit?.icon || 'Sparkles',
      color: editingHabit?.color || Object.keys(COLOR_THEMES)[Math.floor(Math.random() * 7)],
    };
    if (editingHabit?.id) {
      setHabits(prev => prev.map(h => h.id === newHabit.id ? newHabit : h));
    } else {
      setHabits(prev => [...prev, newHabit]);
    }
    setIsEditing(false);
    setEditingHabit(null);
  };

  const handleDeleteHabit = (id) => {
    if (window.confirm('確定要刪除這個習慣嗎？')) {
      setHabits(prev => prev.filter(h => h.id !== id));
    }
  };

  const themeStyles = {
    day: {
      bg: 'bg-stone-100',
      textMain: 'text-stone-800',
      textSub: 'text-stone-500',
      cardBg: 'bg-white',
      cardBorder: 'border-stone-200',
      headerGradient: 'from-emerald-600 to-teal-600',
      buttonActive: 'bg-stone-200 text-stone-800',
      buttonInactive: 'text-stone-400 hover:text-stone-600',
      navBg: 'bg-white/50 border-stone-200/50',
      glowTop: 'bg-emerald-400/20',
      glowBottom: 'bg-teal-400/20',
    },
    night: {
      bg: 'bg-slate-950',
      textMain: 'text-slate-200',
      textSub: 'text-slate-400',
      cardBg: 'bg-slate-800',
      cardBorder: 'border-slate-700',
      headerGradient: 'from-blue-400 to-purple-400',
      buttonActive: 'bg-slate-600 text-white',
      buttonInactive: 'text-slate-400 hover:text-white',
      navBg: 'bg-slate-800/50 border-slate-700/50',
      glowTop: 'bg-blue-600/10',
      glowBottom: 'bg-purple-600/10',
    }
  };
  const t = themeStyles[themeMode];

  // --- UI Components ---

  const SwipeableCard = ({ habit, dateStr, onEdit, onDelete }) => {
    const [offsetX, setOffsetX] = useState(0);
    const startX = useRef(null);
    const isDone = checkStatus(habit.id, dateStr);
    const currentProgress = calculateWeeklyProgress(habit.id, currentDate, logs);
    const isWeeklyGoalMet = currentProgress >= habit.goalPerWeek;
    const themeColor = COLOR_THEMES[habit.color];

    const handleTouchStart = (e) => { startX.current = e.touches[0].clientX; };
    const handleTouchMove = (e) => {
      if (!startX.current) return;
      const currentX = e.touches[0].clientX;
      setOffsetX(currentX - startX.current);
    };
    const handleTouchEnd = () => {
      if (offsetX > 40) setOffsetX(70);
      else if (offsetX < -40) setOffsetX(-70);
      else setOffsetX(0);
      startX.current = null;
    };

    const resetSwipe = () => setOffsetX(0);

    return (
      <div className="relative overflow-hidden rounded-2xl mb-4 select-none h-20 w-full group">
        <div className="absolute inset-0 flex justify-between items-center px-1">
          <button 
            onClick={(e) => { e.stopPropagation(); onEdit(habit); resetSwipe(); }}
            className="h-[90%] w-16 bg-blue-500 flex items-center justify-center rounded-xl text-white font-bold transition-all active:scale-95 z-0"
          >
            <Edit2 size={18} />
          </button>
          <button 
            onClick={(e) => { e.stopPropagation(); onDelete(habit.id); resetSwipe(); }}
            className="h-[90%] w-16 bg-red-500 flex items-center justify-center rounded-xl text-white font-bold transition-all active:scale-95 z-0"
          >
            <Trash2 size={18} />
          </button>
        </div>

        <div 
          className={`
            absolute inset-0 z-10 p-4 transition-transform duration-300 ease-out border rounded-2xl cursor-pointer
            ${isDone 
              ? `bg-gradient-to-r ${themeColor.from} ${themeColor.to} border-transparent shadow-lg` 
              : `${t.cardBg} ${t.cardBorder}`}
          `}
          style={{ transform: `translateX(${offsetX}px)` }}
          onTouchStart={handleTouchStart}
          onTouchMove={handleTouchMove}
          onTouchEnd={handleTouchEnd}
          onClick={() => {
            if (offsetX !== 0) resetSwipe();
            else toggleHabit(habit.id, dateStr);
          }}
        >
          <div className="flex items-center justify-between h-full">
            <div className="flex items-center gap-4">
              <div className={`p-3 rounded-xl transition-colors ${isDone ? 'bg-white/20 text-white' : `${themeMode === 'day' ? 'bg-stone-200 text-stone-600' : 'bg-slate-700 text-slate-400'}`}`}>
                {ICONS[habit.icon] || <Sparkles />}
              </div>
              <div>
                <h3 className={`font-bold text-lg leading-tight ${isDone ? 'text-white' : t.textMain}`}>{habit.title}</h3>
                <div className="flex items-center gap-2 text-xs mt-0.5">
                  <span className={`${isDone ? 'text-white/90' : t.textSub}`}>
                    本週: {currentProgress}/{habit.goalPerWeek} {habit.unit}
                  </span>
                  {isWeeklyGoalMet && (
                    <span className={`${isDone ? 'text-white/30' : 'text-yellow-500'} flex items-center gap-1 bg-white/10 px-1.5 rounded-full`}>
                      <Trophy size={10}/> 達標
                    </span>
                  )}
                </div>
              </div>
            </div>
            <div className={`
              w-7 h-7 rounded-full border-2 flex items-center justify-center transition-all duration-300 flex-shrink-0
              ${isDone ? 'bg-white border-white scale-110' : 'border-stone-400/50'}
            `}>
              {isDone && <Check size={16} className={themeColor.text} />}
            </div>
          </div>
           {!isDone && (
              <div className={`absolute bottom-0 left-0 h-1 w-full ${themeMode === 'day' ? 'bg-stone-200' : 'bg-slate-700'}`}>
                <div 
                  className={`h-full bg-gradient-to-r ${themeColor.from} ${themeColor.to} opacity-50`} 
                  style={{ width: `${Math.min((currentProgress / habit.goalPerWeek) * 100, 100)}%` }}
                />
              </div>
            )}
        </div>
      </div>
    );
  };

  const DailyView = () => (
    <div className="pb-24">
      {habits.map(habit => (
        <SwipeableCard 
          key={habit.id} 
          habit={habit} 
          dateStr={getDateString(currentDate)} 
          onEdit={(h) => { setEditingHabit(h); setIsEditing(true); }}
          onDelete={handleDeleteHabit}
        />
      ))}
    </div>
  );

  const WeeklyView = () => {
    const start = getWeekStart(currentDate);
    const weekDays = getDaysInWeek(start);
    const dayLabels = ['一', '二', '三', '四', '五', '六', '日'];

    return (
      <div className="overflow-x-auto pb-32">
        <div className="min-w-[500px]">
          <div className="grid grid-cols-[100px_repeat(7,1fr)] gap-2 mb-4 text-center text-sm items-end px-2">
            <div className={`text-left font-bold ${t.textSub} pb-1`}>習慣</div>
            {dayLabels.map((d, i) => (
              <div key={i} className={`flex flex-col items-center gap-1 ${weekDays[i] === getDateString(new Date()) ? 'text-blue-500 font-bold' : t.textSub}`}>
                <span className="text-xs opacity-60 leading-none mb-1">{weekDays[i].split('-')[2]}</span>
                <span className="text-sm">{d}</span>
              </div>
            ))}
          </div>

          <div className="space-y-3 px-1">
            {habits.map(habit => {
              const progress = calculateWeeklyProgress(habit.id, currentDate, logs);
              const isGoalMet = progress >= habit.goalPerWeek;
              const themeColor = COLOR_THEMES[habit.color];

              return (
                <div key={habit.id} className={`
                  grid grid-cols-[100px_repeat(7,1fr)] gap-2 items-center p-3 rounded-2xl border transition-all duration-300
                  ${isGoalMet 
                    ? `${themeMode === 'day' ? 'bg-white shadow-md border-emerald-200' : 'bg-slate-800 shadow-xl border-slate-600'}` 
                    : `${t.cardBg} ${t.cardBorder}`}
                `}>
                  <div className="flex flex-col overflow-hidden">
                    <span className={`text-xs font-bold truncate ${t.textMain}`}>{habit.title}</span>
                    <span className={`text-[10px] ${t.textSub}`}>{progress}/{habit.goalPerWeek}</span>
                  </div>
                  {weekDays.map(dayStr => {
                    const checked = checkStatus(habit.id, dayStr);
                    return (
                      <div key={dayStr} className="flex justify-center items-center">
                        <div className={`
                            w-7 h-7 rounded-lg flex items-center justify-center transition-all duration-200
                            ${checked 
                              ? `bg-gradient-to-br ${themeColor.from} ${themeColor.to} text-white shadow-sm` 
                              : `${themeMode === 'day' ? 'bg-stone-200/50' : 'bg-slate-900/50'}`}
                          `}
                        >
                          {checked && <Check size={14} strokeWidth={3} />}
                        </div>
                      </div>
                    );
                  })}
                </div>
              );
            })}
          </div>
        </div>
      </div>
    );
  };

  const StatsView = () => {
    const calculateStats = (habit) => {
      let streak = 0;
      let checkDate = new Date();
      while (true) {
        const progress = calculateWeeklyProgress(habit.id, checkDate, logs);
        if (progress >= habit.goalPerWeek) {
          streak++;
          checkDate.setDate(checkDate.getDate() - 7);
        } else break;
      }
      let totalWeeks = 0;
      let yearDate = new Date(new Date().getFullYear(), 0, 1);
      const now = new Date();
      while (yearDate < now) {
        const progress = calculateWeeklyProgress(habit.id, yearDate, logs);
        if (progress >= habit.goalPerWeek) totalWeeks++;
        yearDate.setDate(yearDate.getDate() + 7);
      }
      return { streak, totalWeeks };
    };

    return (
      <div className="pb-24 space-y-4 px-1">
        <h2 className={`text-xl font-bold mb-4 ${t.textMain}`}>成就統計中心</h2>
        <div className="grid gap-3">
          {habits.map(habit => {
            const stats = calculateStats(habit);
            const themeColor = COLOR_THEMES[habit.color];
            return (
              <div key={habit.id} className={`p-4 rounded-2xl border ${t.cardBg} ${t.cardBorder} flex items-center justify-between shadow-sm`}>
                 <div className="flex items-center gap-3">
                    <div className={`p-2 rounded-lg bg-gradient-to-br ${themeColor.from} ${themeColor.to} text-white shadow-sm`}>
                      {ICONS[habit.icon]}
                    </div>
                    <div>
                      <h3 className={`font-bold text-sm ${t.textMain}`}>{habit.title}</h3>
                      <div className={`text-[10px] uppercase tracking-wide ${t.textSub}`}>目標 每週 {habit.goalPerWeek} {habit.unit}</div>
                    </div>
                 </div>
                 <div className="flex gap-4 items-center">
                    <div className="text-center">
                      <div className={`text-lg font-black ${themeColor.text}`}>{stats.streak}</div>
                      <div className="text-[8px] text-gray-500 uppercase font-bold">連續週數</div>
                    </div>
                    <div className="w-px h-6 bg-gray-500/10"></div>
                    <div className="text-center">
                      <div className={`text-lg font-black ${t.textMain}`}>{stats.totalWeeks}</div>
                      <div className="text-[8px] text-gray-500 uppercase font-bold">年度達成</div>
                    </div>
                 </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  const getWeekRangeText = (date) => {
    const start = getWeekStart(date);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    
    const startMonth = start.getMonth() + 1;
    const startDay = start.getDate();
    const endMonth = end.getMonth() + 1;
    const endDay = end.getDate();

    return `${startMonth}月${startDay}日 - ${endMonth}月${endDay}日`;
  };

  return (
    <div className={`min-h-screen font-sans selection:bg-blue-500/30 transition-colors duration-500 ${t.bg}`}>
      <div className={`max-w-md mx-auto min-h-screen shadow-2xl overflow-hidden flex flex-col relative transition-colors duration-500 ${themeMode === 'day' ? 'bg-white' : 'bg-slate-950'}`}>
        
        {/* Background Glows */}
        <div className={`fixed top-0 left-0 w-full h-96 blur-[100px] pointer-events-none transition-colors duration-700 ${t.glowTop}`} />
        <div className={`fixed bottom-0 right-0 w-full h-96 blur-[100px] pointer-events-none transition-colors duration-700 ${t.glowBottom}`} />

        {/* Celebration Pop-up */}
        {celebration && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center pointer-events-none animate-in fade-in zoom-in duration-300">
             <div className="bg-white/90 backdrop-blur px-8 py-4 rounded-full shadow-2xl flex items-center gap-3 scale-110 border border-white">
                <PartyPopper className="text-yellow-500 animate-bounce" size={32} />
                <span className="text-2xl font-black text-slate-800">{celebration}</span>
             </div>
          </div>
        )}

        <div className="relative z-10 p-6 flex-1 flex flex-col overflow-hidden">
          <div className="flex flex-col gap-4 mb-6">
            <div className="flex justify-between items-center">
              <div>
                <h1 className={`text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r ${t.headerGradient}`}>
                  Habit 2026
                </h1>
                <div className="flex items-center gap-2 text-[10px] font-bold opacity-40 uppercase tracking-widest">
                   {themeMode === 'day' ? <Sun size={10}/> : <Moon size={10}/>}
                   <span>{themeMode === 'day' ? '青山模式' : '海洋模式'}</span>
                </div>
              </div>
              <div className={`flex rounded-xl p-1 ${themeMode === 'day' ? 'bg-stone-200/50' : 'bg-slate-800/50'} backdrop-blur-sm`}>
                {[
                  { id: 'daily', icon: Layout },
                  { id: 'weekly', icon: Calendar },
                  { id: 'stats', icon: TrendingUp }
                ].map(tab => (
                  <button key={tab.id} onClick={() => setView(tab.id)} className={`p-2 rounded-lg transition-all ${view === tab.id ? t.buttonActive + ' shadow-sm' : t.buttonInactive}`}>
                    <tab.icon size={18} />
                  </button>
                ))}
              </div>
            </div>
            {view !== 'stats' && (
              <div className={`flex items-center justify-between p-3 rounded-2xl border backdrop-blur-md shadow-sm ${t.navBg}`}>
                <button onClick={() => {
                  const newDate = new Date(currentDate);
                  if (view === 'daily') newDate.setDate(newDate.getDate() - 1);
                  else newDate.setDate(newDate.getDate() - 7);
                  setCurrentDate(newDate);
                }} className={`p-2 rounded-xl transition-colors ${themeMode === 'day' ? 'hover:bg-stone-200 text-stone-500' : 'hover:bg-slate-700 text-slate-300'}`}>
                  <ChevronLeft size={20} />
                </button>
                <div className="flex flex-col items-center">
                  <span className={`font-black tracking-tight ${view === 'daily' ? 'text-lg' : 'text-sm'} ${t.textMain}`}>
                    {view === 'daily' && currentDate.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' })}
                    {view === 'weekly' && getWeekRangeText(currentDate)}
                  </span>
                </div>
                <button onClick={() => {
                  const newDate = new Date(currentDate);
                  if (view === 'daily') newDate.setDate(newDate.getDate() + 1);
                  else newDate.setDate(newDate.getDate() + 7);
                  setCurrentDate(newDate);
                }} className={`p-2 rounded-xl transition-colors ${themeMode === 'day' ? 'hover:bg-stone-200 text-stone-500' : 'hover:bg-slate-700 text-slate-300'}`}>
                  <ChevronRight size={20} />
                </button>
              </div>
            )}
          </div>
          <div className="flex-1 overflow-y-auto no-scrollbar">
            {view === 'daily' && <DailyView />}
            {view === 'weekly' && <WeeklyView />}
            {view === 'stats' && <StatsView />}
          </div>
        </div>

        <button 
          onClick={() => { setEditingHabit(null); setIsEditing(true); }}
          className={`absolute bottom-8 right-8 w-14 h-14 rounded-2xl shadow-xl flex items-center justify-center text-white transition-all hover:scale-110 active:scale-90 bg-gradient-to-br ${t.headerGradient} z-[50] border border-white/10`}
        >
          <Plus size={28} />
        </button>

        {isEditing && (
          <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md animate-in fade-in duration-200">
            <div className={`w-full max-w-sm p-6 rounded-3xl shadow-2xl ${t.cardBg} border ${t.cardBorder}`}>
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl font-black ${t.textMain}`}>{editingHabit ? '編輯習慣' : '新習慣'}</h3>
                <button onClick={() => setIsEditing(false)} className={t.textSub}><X size={24}/></button>
              </div>
              <form onSubmit={handleSaveHabit} className="space-y-5">
                <div>
                  <label className={`block text-xs font-black mb-1.5 opacity-50 uppercase tracking-widest ${t.textSub}`}>名稱</label>
                  <input name="title" defaultValue={editingHabit?.title} required className={`w-full p-4 rounded-2xl border bg-transparent font-bold ${t.textMain} ${t.cardBorder} outline-none focus:ring-2 focus:ring-blue-500/20`} placeholder="例如：喝水" />
                </div>
                <div className="flex gap-4">
                  <div className="flex-1">
                    <label className={`block text-xs font-black mb-1.5 opacity-50 uppercase tracking-widest ${t.textSub}`}>每週目標</label>
                    <input name="goalPerWeek" type="number" min="1" max="7" defaultValue={editingHabit?.goalPerWeek || 5} required className={`w-full p-4 rounded-2xl border bg-transparent font-bold ${t.textMain} ${t.cardBorder} outline-none focus:ring-2 focus:ring-blue-500/20`} />
                  </div>
                  <div className="flex-1">
                    <label className={`block text-xs font-black mb-1.5 opacity-50 uppercase tracking-widest ${t.textSub}`}>單位</label>
                    <input name="unit" defaultValue={editingHabit?.unit || '次'} required className={`w-full p-4 rounded-2xl border bg-transparent font-bold ${t.textMain} ${t.cardBorder} outline-none focus:ring-2 focus:ring-blue-500/20`} />
                  </div>
                </div>
                <button type="submit" className={`w-full py-4 rounded-2xl font-black mt-4 bg-gradient-to-r ${t.headerGradient} text-white shadow-lg active:scale-95 transition-transform`}>
                  儲存習慣
                </button>
              </form>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
