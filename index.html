<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Habit Tracker 2026</title>
    <!-- 引入核心套件：確保使用正確的 CDN 與 crossorigin 屬性 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入細圓體 -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #020617; 
            margin: 0;
            user-select: none;
            color: white;
            overflow: hidden; /* 防止啟動時捲動 */
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes pop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: pop 0.2s ease-out forwards; }

        #loader {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #020617;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body>
    <!-- 啟動畫面 -->
    <div id="loader">
        <div class="flex flex-col items-center gap-4">
            <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-sm font-bold opacity-50 tracking-widest">HABIT 2026 啟動中</p>
        </div>
    </div>

    <div id="root"></div>

    <!-- 將 Babel 腳本加上 ID 並確保順序 -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 內建圖示 ---
        const Icon = ({ name, className = "w-5 h-5" }) => {
            const icons = {
                droplets: <path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/>,
                footprints: <path d="M4 16v-2.3a2 2 0 1 1 2-2 2 2 0 0 1-2 2zM13 16v-2.3a2 2 0 1 1 2-2 2 2 0 0 1-2 2zM8 20v-2.3a2 2 0 1 1 2-2 2 2 0 0 1-2 2zM17 20v-2.3a2 2 0 1 1 2-2 2 2 0 0 1-2 2z"/>,
                activity: <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>,
                moon: <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>,
                dumbbell: <path d="m6.5 6.5 11 11M3 21l3-3M18 6l3-3M3 13.5h3v-3H3zM18 13.5h3v-3h-3z"/>,
                dog: <path d="M10 5.172C10 3.782 8.423 2.679 6.5 3c-1.923.321-3.5 1.424-3.5 2.814 0 1.258 1.303 2.304 3 2.704v5.3c0 2.21 1.79 4 4 4h4a4 4 0 0 0 4-4V8.518c1.697-.4 3-1.446 3-2.704 0-1.39-1.577-2.493-3.5-2.814-1.923-.321-3.5.782-3.5 2.172v.328h-4v-.328z"/>,
                plus: <path d="M12 5v14M5 12h14"/>,
                check: <path d="M20 6 9 17l-5-5"/>,
                settings: <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V11a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>,
                calendar: <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>,
                layout: <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/>,
                chevronLeft: <polyline points="15 18 9 12 15 6"/>,
                chevronRight: <polyline points="9 18 15 12 9 6"/>,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>,
                sun: <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>,
                sparkles: <path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3z"/>,
                x: <path d="M18 6 6 18M6 6l12 12"/>,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const DEFAULT_HABITS = [
            { id: 'water', title: 'Waterllama 達標', icon: 'droplets', color: 'cyan', goalPerWeek: 5, unit: '天' },
            { id: 'steps', title: '日走 7000 步', icon: 'footprints', color: 'orange', goalPerWeek: 7, unit: '步' },
            { id: 'juc', title: '啾C 課程', icon: 'activity', color: 'pink', goalPerWeek: 3, unit: '次' },
            { id: 'stretch', title: '晚間拉筋 15min', icon: 'moon', color: 'indigo', goalPerWeek: 7, unit: '晚' },
            { id: 'weight', title: '重訓', icon: 'dumbbell', color: 'emerald', goalPerWeek: 4, unit: '次' },
            { id: 'luna', title: 'Luna 訓練', icon: 'dog', color: 'violet', goalPerWeek: 5, unit: '次' },
        ];

        const THEMES = {
            cyan: { from: 'from-cyan-400', to: 'to-blue-500', text: 'text-cyan-500' },
            orange: { from: 'from-orange-400', to: 'to-red-500', text: 'text-orange-500' },
            pink: { from: 'from-pink-400', to: 'to-rose-500', text: 'text-pink-500' },
            indigo: { from: 'from-indigo-400', to: 'to-purple-500', text: 'text-indigo-500' },
            emerald: { from: 'from-emerald-400', to: 'to-green-500', text: 'text-emerald-500' },
            violet: { from: 'from-violet-400', to: 'to-fuchsia-500', text: 'text-violet-500' },
        };

        function App() {
            const [logs, setLogs] = useState(() => {
                try { return JSON.parse(localStorage.getItem('habit_logs') || '{}'); } 
                catch(e) { return {}; }
            });
            const [habits, setHabits] = useState(() => {
                try { return JSON.parse(localStorage.getItem('habit_list') || JSON.stringify(DEFAULT_HABITS)); }
                catch(e) { return DEFAULT_HABITS; }
            });
            const [view, setView] = useState('daily');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [themeMode, setThemeMode] = useState('night');
            const [modal, setModal] = useState(null); // 'edit', 'settings', 'confirmDelete'
            const [editingHabit, setEditingHabit] = useState(null);

            // 當 React 成功執行並啟動後，隱藏載入動畫
            useEffect(() => {
                const loader = document.getElementById('loader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('habit_logs', JSON.stringify(logs));
                localStorage.setItem('habit_list', JSON.stringify(habits));
            }, [logs, habits]);

            const dateStr = currentDate.toISOString().split('T')[0];
            const weekStart = new Date(currentDate);
            weekStart.setDate(weekStart.getDate() - (weekStart.getDay() === 0 ? 6 : weekStart.getDay() - 1));
            weekStart.setHours(0,0,0,0);

            const toggle = (id, dStr) => {
                setLogs(prev => {
                    const next = { ...prev };
                    if (next[`${id}-${dStr}`]) delete next[`${id}-${dStr}`];
                    else next[`${id}-${dStr}`] = true;
                    return next;
                });
            };

            const getWeeklyCount = (id) => {
                let count = 0;
                for (let i = 0; i < 7; i++) {
                    const d = new Date(weekStart);
                    d.setDate(d.getDate() + i);
                    if (logs[`${id}-${d.toISOString().split('T')[0]}`]) count++;
                }
                return count;
            };

            const theme = themeMode === 'day' ? {
                bg: 'bg-stone-100', text: 'text-stone-800', sub: 'text-stone-500', card: 'bg-white', border: 'border-stone-200', grad: 'from-emerald-600 to-teal-600'
            } : {
                bg: 'bg-slate-950', text: 'text-slate-100', sub: 'text-slate-400', card: 'bg-slate-800', border: 'border-slate-700', grad: 'from-blue-400 to-purple-400'
            };

            return (
                <div className={`min-h-screen ${theme.bg} ${theme.text} flex justify-center animate-pop overflow-y-auto`}>
                    <div className="w-full max-w-md min-h-screen flex flex-col relative bg-inherit shadow-2xl overflow-hidden">
                        
                        {/* 背景飾光 */}
                        <div className={`absolute top-0 w-full h-64 blur-[100px] opacity-10 pointer-events-none bg-gradient-to-b ${theme.grad}`} />

                        {/* Header */}
                        <header className="p-6 pb-0 z-10">
                            <div className="flex justify-between items-center mb-6">
                                <div onClick={() => setThemeMode(themeMode === 'day' ? 'night' : 'day')} className="cursor-pointer">
                                    <h1 className={`text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r ${theme.grad}`}>Habit 2026</h1>
                                    <div className="text-[10px] font-bold opacity-40 flex items-center gap-1 uppercase tracking-widest">
                                        <Icon name={themeMode === 'day' ? 'sun' : 'moon'} className="w-3 h-3" />
                                        {themeMode === 'day' ? '青山模式' : '海洋模式'}
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setModal('settings')} className="p-2 opacity-50 hover:opacity-100 transition-opacity"><Icon name="settings" /></button>
                                    <div className="flex bg-white/10 p-1 rounded-xl backdrop-blur-sm">
                                        <button onClick={()=>setView('daily')} className={`p-2 rounded-lg transition-all ${view==='daily'?'bg-white/20 shadow-sm text-white':'opacity-40'}`}><Icon name="layout" /></button>
                                        <button onClick={()=>setView('weekly')} className={`p-2 rounded-lg transition-all ${view==='weekly'?'bg-white/20 shadow-sm text-white':'opacity-40'}`}><Icon name="calendar" /></button>
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center justify-between p-3 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-md">
                                <button onClick={() => { const d = new Date(currentDate); d.setDate(d.getDate() - (view === 'daily' ? 1 : 7)); setCurrentDate(d); }} className="p-1"><Icon name="chevronLeft" className="opacity-50"/></button>
                                <span className="font-bold text-base">
                                    {view === 'daily' ? currentDate.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'short' }) : `${weekStart.getMonth()+1}/${weekStart.getDate()} 當週概覽`}
                                </span>
                                <button onClick={() => { const d = new Date(currentDate); d.setDate(d.getDate() + (view === 'daily' ? 1 : 7)); setCurrentDate(d); }} className="p-1"><Icon name="chevronRight" className="opacity-50"/></button>
                            </div>
                        </header>

                        {/* 主要內容 */}
                        <main className="flex-1 p-6 overflow-y-auto no-scrollbar">
                            {view === 'daily' ? (
                                habits.map(h => {
                                    const done = !!logs[`${h.id}-${dateStr}`];
                                    const c = THEMES[h.color] || THEMES.cyan;
                                    return (
                                        <div key={h.id} onClick={() => toggle(h.id, dateStr)} className={`p-4 rounded-2xl mb-4 border transition-all active:scale-95 cursor-pointer flex items-center justify-between ${done ? `bg-gradient-to-r ${c.from} ${c.to} text-white border-transparent shadow-lg` : `${theme.card} ${theme.border}`}`}>
                                            <div className="flex items-center gap-4">
                                                <div className={`p-3 rounded-xl ${done ? 'bg-white/20' : 'bg-black/5 dark:bg-white/5'}`}><Icon name={h.icon} className="w-6 h-6"/></div>
                                                <div>
                                                    <div className="font-bold text-lg leading-tight">{h.title}</div>
                                                    <div className={`text-xs ${done ? 'opacity-80' : 'opacity-40'}`}>本週: {getWeeklyCount(h.id)}/{h.goalPerWeek} {h.unit}</div>
                                                </div>
                                            </div>
                                            <div className={`w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${done ? 'bg-white border-white scale-110' : 'border-current opacity-20'}`}>
                                                {done && <Icon name="check" className={`w-5 h-5 ${c.text}`} />}
                                            </div>
                                        </div>
                                    );
                                })
                            ) : (
                                <div className="overflow-x-auto"><div className="min-w-[420px]">
                                    <div className="grid grid-cols-[80px_repeat(7,1fr)] gap-2 mb-6 text-center text-sm font-bold opacity-60 uppercase">
                                        <div>習慣</div>
                                        {['一','二','三','四','五','六','日'].map((l, i) => {
                                            const d = new Date(weekStart); d.setDate(d.getDate()+i);
                                            return <div key={i}><div className="text-lg text-blue-400 font-black mb-1">{d.getDate()}</div>{l}</div>
                                        })}
                                    </div>
                                    {habits.map(h => (
                                        <div key={h.id} className="grid grid-cols-[80px_repeat(7,1fr)] gap-2 items-center mb-6">
                                            <div className="text-sm font-bold truncate pr-2 opacity-80">{h.title}</div>
                                            {[0,1,2,3,4,5,6].map(i => {
                                                const d = new Date(weekStart); d.setDate(d.getDate() + i);
                                                const dS = d.toISOString().split('T')[0];
                                                const done = !!logs[`${h.id}-${dS}`];
                                                return (
                                                    <div key={i} className="flex justify-center" onClick={() => toggle(h.id, dS)}>
                                                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all cursor-pointer ${done ? `bg-gradient-to-br ${THEMES[h.color].from} ${THEMES[h.color].to} text-white shadow-md` : 'bg-white/5 border border-white/10'}`}>
                                                            {done && <Icon name="check" className="w-5 h-5" />}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ))}
                                </div></div>
                            )}
                        </main>

                        {/* 懸浮按鈕 */}
                        <button onClick={() => { setEditingHabit(null); setModal('edit'); }} className={`fixed bottom-8 right-8 w-14 h-14 rounded-2xl shadow-xl flex items-center justify-center text-white bg-gradient-to-r ${theme.grad} active:scale-90 transition-transform z-40 border border-white/20`}><Icon name="plus" className="w-8 h-8"/></button>

                        {/* 彈出視窗：管理與編輯 */}
                        {modal && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-pop">
                                <div className={`w-full max-w-xs p-6 rounded-3xl ${theme.card} border ${theme.border} shadow-2xl relative text-white`}>
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="font-black text-xl">
                                            {modal === 'settings' ? '資料管理' : 
                                             modal === 'confirmDelete' ? '確定刪除？' :
                                             (editingHabit ? '編輯習慣' : '新習慣')}
                                        </h2>
                                        <button onClick={()=>setModal(null)} className="p-1"><Icon name="x" className="w-6 h-6 opacity-50"/></button>
                                    </div>

                                    {modal === 'settings' && (
                                        <div className="space-y-4">
                                            <button onClick={() => { 
                                                const b = new Blob([JSON.stringify({logs, habits})], {type:'application/json'}); 
                                                const a = document.createElement('a'); 
                                                a.href = URL.createObjectURL(b); 
                                                a.download='habit-backup.json'; 
                                                a.click(); 
                                            }} className="w-full p-4 rounded-2xl border border-white/10 bg-white/5 flex justify-between items-center font-bold">
                                                <span>下載備份 (.json)</span>
                                                <Icon name="download" className="w-5 h-5"/>
                                            </button>
                                            <p className="text-[10px] opacity-40 text-center leading-relaxed">提示：資料目前存於瀏覽器中，清除快取後紀錄會消失。</p>
                                        </div>
                                    )}

                                    {modal === 'edit' && (
                                        <form onSubmit={(e) => {
                                            e.preventDefault();
                                            const fd = new FormData(e.target);
                                            const nH = { id: editingHabit?.id || `h-${Date.now()}`, title: fd.get('title'), goalPerWeek: parseInt(fd.get('goalPerWeek')), unit: fd.get('unit'), icon: editingHabit?.icon || 'sparkles', color: editingHabit?.color || 'cyan' };
                                            setHabits(prev => editingHabit ? prev.map(h => h.id === nH.id ? nH : h) : [...prev, nH]);
                                            setModal(null);
                                        }} className="space-y-4 text-white">
                                            <input name="title" required defaultValue={editingHabit?.title} className="w-full p-4 rounded-xl border border-white/10 bg-white/5 outline-none focus:border-blue-500 transition-colors" placeholder="習慣名稱" />
                                            <div className="flex gap-2">
                                                <div className="flex-1">
                                                    <label className="text-[10px] opacity-40 font-bold ml-1 uppercase">每週目標</label>
                                                    <input name="goalPerWeek" type="number" min="1" max="7" defaultValue={editingHabit?.goalPerWeek || 5} className="w-full p-4 rounded-xl border border-white/10 bg-white/5 outline-none focus:border-blue-500" />
                                                </div>
                                                <div className="flex-1">
                                                    <label className="text-[10px] opacity-40 font-bold ml-1 uppercase">單位</label>
                                                    <input name="unit" defaultValue={editingHabit?.unit || '次'} className="w-full p-4 rounded-xl border border-white/10 bg-white/5 outline-none focus:border-blue-500" />
                                                </div>
                                            </div>
                                            <div className="flex gap-2 pt-2">
                                                {editingHabit && (
                                                    <button type="button" onClick={() => setModal('confirmDelete')} className="p-4 rounded-2xl bg-red-500/20 text-red-500">
                                                        <Icon name="trash" className="w-5 h-5"/>
                                                    </button>
                                                )}
                                                <button type="submit" className={`flex-1 p-4 rounded-2xl text-white font-bold bg-gradient-to-r ${theme.grad} shadow-lg active:scale-95 transition-transform`}>儲存習慣</button>
                                            </div>
                                        </form>
                                    )}

                                    {modal === 'confirmDelete' && (
                                        <div className="space-y-6">
                                            <p className="text-sm opacity-70 leading-relaxed">您確定要刪除「{editingHabit?.title}」嗎？此操作將永久移除該習慣及其所有打卡紀錄。</p>
                                            <div className="flex gap-3">
                                                <button onClick={() => setModal('edit')} className="flex-1 p-3 rounded-xl border border-white/10 font-bold">取消</button>
                                                <button onClick={() => {
                                                    setHabits(habits.filter(h => h.id !== editingHabit.id));
                                                    setModal(null);
                                                }} className="flex-1 p-3 rounded-xl bg-red-500 text-white font-bold">確定刪除</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // 確保 DOM 加載完畢且 Babel 編譯完成後啟動
        const init = () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                try {
                    const root = ReactDOM.createRoot(rootElement);
                    root.render(<App />);
                } catch (err) {
                    console.error("App Render Error:", err);
                    document.getElementById('loader').innerHTML = '<p style="color:red; font-size:12px;">啟動失敗，請重新整理</p>';
                }
            }
        };

        // 監聽 DOM 準備狀態
        if (document.readyState === 'complete') {
            init();
        } else {
            window.addEventListener('load', init);
        }
    </script>
</body>
</html>
