<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker 2026</title>
    <!-- 引入 React, Babel 與 Tailwind CSS -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide 圖示 (UMD 版本) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* 簡單的動畫 */
        @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: fade-in 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 預設習慣
        const DEFAULT_HABITS = [
            { id: 'water', title: 'Waterllama 達標', icon: 'droplets', color: 'cyan', goalPerWeek: 5, unit: '天' },
            { id: 'steps', title: '日走 7000 步', icon: 'footprints', color: 'orange', goalPerWeek: 7, unit: '步' },
            { id: 'juc', title: '啾C 課程', icon: 'activity', color: 'pink', goalPerWeek: 3, unit: '次' },
            { id: 'stretch', title: '晚間拉筋 15min', icon: 'moon', color: 'indigo', goalPerWeek: 7, unit: '晚' },
            { id: 'weight', title: '重訓', icon: 'dumbbell', color: 'emerald', goalPerWeek: 4, unit: '次' },
            { id: 'luna', title: 'Luna 訓練', icon: 'dog', color: 'violet', goalPerWeek: 5, unit: '次' },
        ];

        const COLOR_THEMES = {
            cyan: { from: 'from-cyan-400', to: 'to-blue-500', text: 'text-cyan-500', bg: 'bg-cyan-500' },
            orange: { from: 'from-orange-400', to: 'to-red-500', text: 'text-orange-500', bg: 'bg-orange-500' },
            pink: { from: 'from-pink-400', to: 'to-rose-500', text: 'text-pink-500', bg: 'bg-pink-500' },
            indigo: { from: 'from-indigo-400', to: 'to-purple-500', text: 'text-indigo-500', bg: 'bg-indigo-500' },
            emerald: { from: 'from-emerald-400', to: 'to-green-500', text: 'text-emerald-500', bg: 'bg-emerald-500' },
            yellow: { from: 'from-yellow-400', to: 'to-amber-500', text: 'text-yellow-500', bg: 'bg-yellow-500' },
            violet: { from: 'from-violet-400', to: 'to-fuchsia-500', text: 'text-violet-500', bg: 'bg-violet-500' },
        };

        // Lucide 圖示渲染組件
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current) {
                    ref.current.innerHTML = lucide.createIcons({
                        icons: { [name]: true },
                        attrs: { strokeWidth: 2, width: size, height: size }
                    })[name];
                }
            }, [name, size]);
            return <i ref={ref} className={`inline-block ${className}`} />;
        };

        // 輔助函式
        const getDateString = (date) => date.toISOString().split('T')[0];
        const getWeekStart = (date) => {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - (day === 0 ? 6 : day - 1);
            d.setDate(diff);
            d.setHours(0,0,0,0);
            return d;
        };
        const getDaysInWeek = (startDate) => {
            const days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(d.getDate() + i);
                days.push(getDateString(d));
            }
            return days;
        };

        const calculateWeeklyProgress = (habitId, date, logs) => {
            const start = getWeekStart(date);
            const weekDays = getDaysInWeek(start);
            let count = 0;
            weekDays.forEach(d => { if (logs[`${habitId}-${d}`]) count++; });
            return count;
        };

        function App() {
            const [logs, setLogs] = useState({});
            const [habits, setHabits] = useState(DEFAULT_HABITS);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [view, setView] = useState('daily');
            const [themeMode, setThemeMode] = useState('night');
            const [isEditing, setIsEditing] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [editingHabit, setEditingHabit] = useState(null);
            const [celebration, setCelebration] = useState(null);

            useEffect(() => {
                const savedLogs = localStorage.getItem('habit2026_logs');
                const savedHabits = localStorage.getItem('habit2026_list');
                if (savedLogs) setLogs(JSON.parse(savedLogs));
                if (savedHabits) setHabits(JSON.parse(savedHabits));
                const hour = new Date().getHours();
                setThemeMode(hour >= 6 && hour < 18 ? 'day' : 'night');
            }, []);

            useEffect(() => {
                localStorage.setItem('habit2026_logs', JSON.stringify(logs));
                localStorage.setItem('habit2026_list', JSON.stringify(habits));
            }, [logs, habits]);

            const theme = {
                day: { bg: 'bg-stone-100', textMain: 'text-stone-800', textSub: 'text-stone-500', cardBg: 'bg-white', cardBorder: 'border-stone-200', headerGradient: 'from-emerald-600 to-teal-600', buttonActive: 'bg-stone-200 text-stone-800', buttonInactive: 'text-stone-400', navBg: 'bg-white/50', glow: 'bg-emerald-400/20' },
                night: { bg: 'bg-slate-950', textMain: 'text-slate-200', textSub: 'text-slate-400', cardBg: 'bg-slate-800', cardBorder: 'border-slate-700', headerGradient: 'from-blue-400 to-purple-400', buttonActive: 'bg-slate-600 text-white', buttonInactive: 'text-slate-400', navBg: 'bg-slate-800/50', glow: 'bg-blue-600/10' }
            }[themeMode];

            const toggleHabit = (id, dateStr) => {
                const key = `${id}-${dateStr}`;
                setLogs(prev => {
                    const next = { ...prev };
                    if (next[key]) delete next[key];
                    else {
                        next[key] = true;
                        setCelebration("做得好！");
                        setTimeout(() => setCelebration(null), 1500);
                    }
                    return next;
                });
            };

            const exportData = () => {
                const data = { logs, habits };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `habit-backup-${getDateString(new Date())}.json`;
                a.click();
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.logs) setLogs(data.logs);
                        if (data.habits) setHabits(data.habits);
                        alert('匯入成功！');
                    } catch (err) { alert('匯入失敗'); }
                };
                reader.readAsText(file);
            };

            const handleSaveHabit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const newHabit = {
                    id: editingHabit?.id || `h-${Date.now()}`,
                    title: formData.get('title'),
                    goalPerWeek: parseInt(formData.get('goalPerWeek')),
                    unit: formData.get('unit'),
                    icon: editingHabit?.icon || 'sparkles',
                    color: editingHabit?.color || 'cyan',
                };
                if (editingHabit) setHabits(habits.map(h => h.id === newHabit.id ? newHabit : h));
                else setHabits([...habits, newHabit]);
                setIsEditing(false);
                setEditingHabit(null);
            };

            // 滑動卡片組件 (整合版)
            const HabitCard = ({ habit }) => {
                const dateStr = getDateString(currentDate);
                const isDone = !!logs[`${habit.id}-${dateStr}`];
                const color = COLOR_THEMES[habit.color];
                const progress = calculateWeeklyProgress(habit.id, currentDate, logs);
                
                return (
                    <div 
                        onClick={() => toggleHabit(habit.id, dateStr)}
                        className={`p-4 rounded-2xl border transition-all cursor-pointer relative overflow-hidden mb-4 ${isDone ? `bg-gradient-to-r ${color.from} ${color.to} border-transparent text-white shadow-lg scale-[1.02]` : `${theme.cardBg} ${theme.cardBorder} ${theme.textMain}`}`}
                    >
                        <div className="flex justify-between items-center relative z-10">
                            <div className="flex items-center gap-4">
                                <div className={`p-3 rounded-xl ${isDone ? 'bg-white/20' : 'bg-stone-100 dark:bg-slate-700'}`}>
                                    <Icon name={habit.icon} size={24} />
                                </div>
                                <div>
                                    <div className="font-bold text-lg">{habit.title}</div>
                                    <div className={`text-xs ${isDone ? 'text-white/80' : theme.textSub}`}>本週目標: {progress}/{habit.goalPerWeek} {habit.unit}</div>
                                </div>
                            </div>
                            <div className={`w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${isDone ? 'bg-white border-white' : 'border-current opacity-20'}`}>
                                {isDone && <Icon name="check" size={18} className={color.text} />}
                            </div>
                        </div>
                    </div>
                );
            };

            const WeeklyTable = () => {
                const start = getWeekStart(currentDate);
                const weekDays = getDaysInWeek(start);
                const labels = ['一', '二', '三', '四', '五', '六', '日'];
                return (
                    <div className="overflow-x-auto pb-10">
                        <div className="min-w-[400px]">
                            <div className="grid grid-cols-[80px_repeat(7,1fr)] gap-2 mb-4 text-center">
                                <div className={`text-left text-xs font-bold ${theme.textSub}`}>習慣</div>
                                {labels.map((l, i) => (
                                    <div key={i} className={`flex flex-col items-center`}>
                                        <span className={`text-[10px] opacity-50`}>{weekDays[i].split('-')[2]}</span>
                                        <span className={`text-sm font-bold ${theme.textMain}`}>{l}</span>
                                    </div>
                                ))}
                            </div>
                            {habits.map(h => (
                                <div key={h.id} className="grid grid-cols-[80px_repeat(7,1fr)] gap-2 items-center mb-3">
                                    <div className={`text-xs font-bold truncate ${theme.textMain}`}>{h.title}</div>
                                    {weekDays.map(d => {
                                        const done = !!logs[`${h.id}-${d}`];
                                        return (
                                            <div key={d} className="flex justify-center">
                                                <div className={`w-7 h-7 rounded-lg flex items-center justify-center ${done ? `bg-gradient-to-br ${COLOR_THEMES[h.color].from} ${COLOR_THEMES[h.color].to} text-white` : 'bg-stone-200/30'}`}>
                                                    {done && <Icon name="check" size={14} />}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen transition-colors duration-500 ${theme.bg}`}>
                    <div className={`max-w-md mx-auto min-h-screen relative flex flex-col ${themeMode === 'day' ? 'bg-white' : 'bg-slate-950'} shadow-2xl`}>
                        <div className={`absolute top-0 w-full h-80 blur-[100px] pointer-events-none ${theme.glow}`} />
                        
                        <div className="relative z-10 p-6 flex-1 flex flex-col">
                            {/* Header */}
                            <div className="flex justify-between items-center mb-8">
                                <div>
                                    <h1 className={`text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r ${theme.headerGradient}`}>Habit 2026</h1>
                                    <div className="text-[10px] font-bold opacity-40 tracking-widest uppercase flex items-center gap-1">
                                        <Icon name={themeMode === 'day' ? 'sun' : 'moon'} size={10} />
                                        {themeMode === 'day' ? '青山模式' : '海洋模式'}
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setIsSettingsOpen(true)} className={`p-2 rounded-xl ${theme.buttonInactive}`}><Icon name="settings" size={20}/></button>
                                    <div className={`flex rounded-xl p-1 ${themeMode === 'day' ? 'bg-stone-200/40' : 'bg-slate-800/40'}`}>
                                        <button onClick={()=>setView('daily')} className={`p-2 rounded-lg ${view==='daily'?theme.buttonActive:theme.buttonInactive}`}><Icon name="layout" size={18}/></button>
                                        <button onClick={()=>setView('weekly')} className={`p-2 rounded-lg ${view==='weekly'?theme.buttonActive:theme.buttonInactive}`}><Icon name="calendar" size={18}/></button>
                                    </div>
                                </div>
                            </div>

                            {/* Date Navigation */}
                            <div className={`flex items-center justify-between p-3 mb-6 rounded-2xl border backdrop-blur-md ${theme.navBg} ${theme.cardBorder}`}>
                                <button onClick={() => { const d = new Date(currentDate); d.setDate(d.getDate()-(view==='daily'?1:7)); setCurrentDate(d); }} className={theme.textSub}><Icon name="chevron-left" /></button>
                                <div className={`font-bold ${theme.textMain}`}>{view === 'daily' ? currentDate.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'short' }) : '本週概覽'}</div>
                                <button onClick={() => { const d = new Date(currentDate); d.setDate(d.getDate()+(view==='daily'?1:7)); setCurrentDate(d); }} className={theme.textSub}><Icon name="chevron-right" /></button>
                            </div>

                            {/* Main Content */}
                            <div className="flex-1 overflow-y-auto no-scrollbar">
                                {view === 'daily' ? (
                                    habits.map(h => <HabitCard key={h.id} habit={h} />)
                                ) : (
                                    <WeeklyTable />
                                )}
                            </div>
                        </div>

                        {/* Floating Action Button */}
                        <button onClick={() => setIsEditing(true)} className={`absolute bottom-8 right-8 w-14 h-14 rounded-2xl shadow-xl flex items-center justify-center text-white bg-gradient-to-r ${theme.headerGradient} active:scale-90 transition-transform`}><Icon name="plus" size={28} /></button>

                        {/* Settings Modal */}
                        {isSettingsOpen && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm animate-pop">
                                <div className={`w-full max-w-xs p-6 rounded-3xl ${theme.cardBg} ${theme.textMain}`}>
                                    <div className="flex justify-between items-center mb-6"><h2 className="font-black text-xl">資料管理</h2><button onClick={()=>setIsSettingsOpen(false)}><Icon name="x"/></button></div>
                                    <button onClick={exportData} className="w-full p-4 mb-3 rounded-2xl border flex justify-between items-center font-bold"><span>下載備份 (.json)</span><Icon name="download"/></button>
                                    <label className="w-full p-4 mb-3 rounded-2xl border flex justify-between items-center font-bold cursor-pointer"><span>匯入備份</span><Icon name="upload"/><input type="file" onChange={importData} className="hidden"/></label>
                                    <p className="text-[10px] opacity-50 leading-relaxed">提示：資料目前儲存在瀏覽器中。清除快取會導致紀錄消失，建議每週備份一次檔案。</p>
                                </div>
                            </div>
                        )}

                        {/* Add Habit Modal */}
                        {isEditing && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm animate-pop">
                                <div className={`w-full max-w-xs p-6 rounded-3xl ${theme.cardBg} ${theme.textMain}`}>
                                    <div className="flex justify-between mb-6"><h2 className="font-black text-xl">新習慣</h2><button onClick={()=>setIsEditing(false)}><Icon name="x"/></button></div>
                                    <form onSubmit={handleSaveHabit} className="space-y-4">
                                        <input name="title" required className="w-full p-3 rounded-xl border bg-transparent" placeholder="習慣名稱" />
                                        <div className="flex gap-2">
                                            <input name="goalPerWeek" type="number" min="1" max="7" defaultValue="5" className="flex-1 p-3 rounded-xl border bg-transparent" />
                                            <input name="unit" defaultValue="次" className="flex-1 p-3 rounded-xl border bg-transparent" />
                                        </div>
                                        <button type="submit" className={`w-full p-4 rounded-2xl text-white font-bold bg-gradient-to-r ${theme.headerGradient}`}>儲存</button>
                                    </form>
                                </div>
                            </div>
                        )}

                        {/* Celebration */}
                        {celebration && (
                            <div className="fixed inset-0 pointer-events-none flex items-center justify-center z-50">
                                <div className="bg-white/90 px-8 py-4 rounded-full shadow-2xl flex items-center gap-2 animate-bounce border border-white">
                                    <Icon name="party-popper" className="text-yellow-500" />
                                    <span className="text-xl font-black text-slate-800">{celebration}</span>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
