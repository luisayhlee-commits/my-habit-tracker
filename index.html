import React, { useState, useEffect, useRef } from 'react';
import { 
  Check, Calendar, Layout, ChevronLeft, ChevronRight, 
  Droplets, Footprints, Dumbbell, Sparkles, Moon, Dog, Trophy, Activity,
  TrendingUp, Plus, X, Edit2, Trash2, Sun, PartyPopper
} from 'lucide-react';

// --- 配置資料 ---
const DEFAULT_HABITS = [
  { id: 'water', title: 'Waterllama 達標', icon: 'Droplets', color: 'cyan', goalPerWeek: 5, unit: '天' },
  { id: 'steps', title: '日走 7000 步', icon: 'Footprints', color: 'orange', goalPerWeek: 7, unit: '步' },
  { id: 'juc', title: '啾C 課程', icon: 'Activity', color: 'pink', goalPerWeek: 3, unit: '次' },
  { id: 'stretch', title: '晚間拉筋 15min', icon: 'Moon', color: 'indigo', goalPerWeek: 7, unit: '晚' },
  { id: 'weight', title: '重訓', icon: 'Dumbbell', color: 'emerald', goalPerWeek: 4, unit: '次' },
  { id: 'coach', title: '教練課', icon: 'Trophy', color: 'yellow', goalPerWeek: 1, unit: '堂' },
  { id: 'luna', title: 'Luna 訓練', icon: 'Dog', color: 'violet', goalPerWeek: 5, unit: '次' },
];

const ICONS = {
  Droplets: <Droplets />, Footprints: <Footprints />, Activity: <Activity />,
  Moon: <Moon />, Dumbbell: <Dumbbell />, Trophy: <Trophy />,
  Dog: <Dog />, Sparkles: <Sparkles />, Check: <Check />
};

const COLOR_THEMES = {
  cyan: { from: 'from-cyan-400', to: 'to-blue-500', text: 'text-cyan-500' },
  orange: { from: 'from-orange-400', to: 'to-red-500', text: 'text-orange-500' },
  pink: { from: 'from-pink-400', to: 'to-rose-500', text: 'text-pink-500' },
  indigo: { from: 'from-indigo-400', to: 'to-purple-500', text: 'text-indigo-500' },
  emerald: { from: 'from-emerald-400', to: 'to-green-500', text: 'text-emerald-500' },
  yellow: { from: 'from-yellow-400', to: 'to-amber-500', text: 'text-yellow-500' },
  violet: { from: 'from-violet-400', to: 'to-fuchsia-500', text: 'text-violet-500' },
};

// --- 工具函數 ---
const getDateStr = (d) => d.toISOString().split('T')[0];
const getWeekStart = (date) => {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - (day === 0 ? 6 : day - 1);
  d.setDate(diff);
  d.setHours(0,0,0,0);
  return d;
};

export default function App() {
  const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('h26_logs') || '{}'));
  const [habits, setHabits] = useState(() => JSON.parse(localStorage.getItem('h26_list') || JSON.stringify(DEFAULT_HABITS)));
  const [currentDate, setCurrentDate] = useState(new Date());
  const [view, setView] = useState('daily');
  const [theme, setTheme] = useState('night');
  const [editingHabit, setEditingHabit] = useState(null);
  const [celebration, setCelebration] = useState(null);

  useEffect(() => {
    localStorage.setItem('h26_logs', JSON.stringify(logs));
    localStorage.setItem('h26_list', JSON.stringify(habits));
  }, [logs, habits]);

  const toggleHabit = (id, date) => {
    const key = `${id}-${date}`;
    setLogs(prev => {
      const next = { ...prev };
      if (next[key]) delete next[key];
      else {
        next[key] = true;
        setCelebration(["太棒了！", "持續前進！", "你做到了！"][Math.floor(Math.random()*3)]);
        setTimeout(() => setCelebration(null), 1200);
      }
      return next;
    });
  };

  const getWeekProgress = (id, date) => {
    const start = getWeekStart(date);
    let count = 0;
    for(let i=0; i<7; i++) {
      const d = new Date(start); d.setDate(start.getDate() + i);
      if (logs[`${id}-${getDateStr(d)}`]) count++;
    }
    return count;
  };

  const t = theme === 'day' ? {
    bg: 'bg-stone-50', text: 'text-stone-800', card: 'bg-white border-stone-200', sub: 'text-stone-400', accent: 'from-emerald-600 to-teal-600'
  } : {
    bg: 'bg-slate-950', text: 'text-slate-100', card: 'bg-slate-800 border-slate-700', sub: 'text-slate-500', accent: 'from-blue-400 to-purple-400'
  };

  // --- 內建組件：滑動卡片 ---
  const HabitCard = ({ habit }) => {
    const [offsetX, setOffsetX] = useState(0);
    const startX = useRef(0);
    const dateStr = getDateStr(currentDate);
    const isDone = !!logs[`${habit.id}-${dateStr}`];
    const prog = getWeekProgress(habit.id, currentDate);
    const c = COLOR_THEMES[habit.color];

    return (
      <div className="relative h-20 overflow-hidden rounded-2xl group mb-4">
        {/* 底層按鈕 */}
        <div className="absolute inset-0 flex justify-between items-center px-2">
          <button onClick={() => setEditingHabit(habit)} className="w-14 h-[85%] bg-blue-500 rounded-xl flex items-center justify-center text-white"><Edit2 size={18}/></button>
          <button onClick={() => {
            if(window.confirm('確定刪除？')) setHabits(habits.filter(h => h.id !== habit.id));
          }} className="w-14 h-[85%] bg-red-500 rounded-xl flex items-center justify-center text-white"><Trash2 size={18}/></button>
        </div>
        {/* 上層內容 */}
        <div 
          className={`absolute inset-0 z-10 p-4 border rounded-2xl transition-transform duration-300 flex items-center justify-between cursor-pointer ${isDone ? `bg-gradient-to-r ${c.from} ${c.to} border-transparent shadow-lg` : `${t.card}`}`}
          style={{ transform: `translateX(${offsetX}px)` }}
          onTouchStart={e => startX.current = e.touches[0].clientX}
          onTouchMove={e => setOffsetX(e.touches[0].clientX - startX.current)}
          onTouchEnd={() => setOffsetX(offsetX > 50 ? 70 : offsetX < -50 ? -70 : 0)}
          onClick={() => offsetX === 0 ? toggleHabit(habit.id, dateStr) : setOffsetX(0)}
        >
          <div className="flex items-center gap-4">
            <div className={`p-2.5 rounded-xl ${isDone ? 'bg-white/20 text-white' : 'bg-stone-200/50 text-stone-500 dark:bg-slate-700'}`}>
              {React.cloneElement(ICONS[habit.icon] || <Sparkles />, { size: 20 })}
            </div>
            <div>
              <h3 className={`font-bold ${isDone ? 'text-white' : t.text}`}>{habit.title}</h3>
              <p className={`text-[10px] ${isDone ? 'text-white/80' : t.sub}`}>本週: {prog}/{habit.goalPerWeek} {habit.unit}</p>
            </div>
          </div>
          <div className={`w-7 h-7 rounded-full border-2 flex items-center justify-center ${isDone ? 'bg-white border-white' : 'border-stone-300'}`}>
            {isDone && <Check size={16} className={c.text} />}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className={`min-h-screen ${t.bg} ${t.text} transition-colors duration-500 flex justify-center p-6`}>
      <div className="w-full max-w-md flex flex-col relative">
        
        {/* Celebration */}
        {celebration && (
          <div className="fixed inset-0 z-50 flex items-center justify-center pointer-events-none animate-bounce">
            <div className="bg-white px-8 py-3 rounded-full shadow-2xl flex items-center gap-2 border-2 border-yellow-400">
              <PartyPopper className="text-yellow-500" />
              <span className="text-xl font-black text-slate-800">{celebration}</span>
            </div>
          </div>
        )}

        {/* Header */}
        <header className="flex justify-between items-center mb-8">
          <div>
            <h1 className={`text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r ${t.accent}`}>Habit 2026</h1>
            <p className="text-[10px] font-bold opacity-30 uppercase tracking-widest">{theme === 'day' ? '青山模式' : '海洋模式'}</p>
          </div>
          <div className="flex bg-white/5 backdrop-blur-md rounded-xl p-1 border border-white/10">
            {[{id:'daily', i:Layout}, {id:'weekly', i:Calendar}, {id:'stats', i:TrendingUp}].map(x => (
              <button key={x.id} onClick={() => setView(x.id)} className={`p-2 rounded-lg transition-all ${view === x.id ? 'bg-white/20 shadow-sm' : 'opacity-30'}`}>
                <x.i size={18} />
              </button>
            ))}
          </div>
        </header>

        {/* Date Selector */}
        {view !== 'stats' && (
          <div className={`flex items-center justify-between p-4 rounded-3xl border mb-6 backdrop-blur-sm ${t.card}`}>
            <button onClick={() => {
              const d = new Date(currentDate);
              d.setDate(d.getDate() - (view === 'daily' ? 1 : 7));
              setCurrentDate(d);
            }}><ChevronLeft /></button>
            <div className="text-center">
              <span className={`font-black tracking-tighter ${view === 'daily' ? 'text-3xl' : 'text-base'}`}>
                {view === 'daily' ? currentDate.toLocaleDateString('zh-TW', {month:'long', day:'numeric'}) : 
                  `${getWeekStart(currentDate).getMonth()+1}月${getWeekStart(currentDate).getDate()}日 - ${new Date(getWeekStart(currentDate).getTime()+6*864e5).getMonth()+1}月${new Date(getWeekStart(currentDate).getTime()+6*864e5).getDate()}日`}
              </span>
              {view === 'daily' && <div className="text-[10px] opacity-40 font-bold uppercase mt-1">{currentDate.toLocaleDateString('zh-TW', {weekday:'long'})}</div>}
            </div>
            <button onClick={() => {
              const d = new Date(currentDate);
              d.setDate(d.getDate() + (view === 'daily' ? 1 : 7));
              setCurrentDate(d);
            }}><ChevronRight /></button>
          </div>
        )}

        {/* Main Content */}
        <main className="flex-1 overflow-y-auto no-scrollbar">
          {view === 'daily' && <div className="pb-24">{habits.map(h => <HabitCard key={h.id} habit={h} />)}</div>}
          
          {view === 'weekly' && (
            <div className="pb-32 overflow-x-auto">
              <div className="min-w-[450px]">
                <div className="grid grid-cols-[100px_repeat(7,1fr)] mb-4 text-center text-[10px] font-bold opacity-40 uppercase">
                  <div className="text-left pl-2">習慣</div>
                  {['一','二','三','四','五','六','日'].map(d => <div key={d}>{d}</div>)}
                </div>
                {habits.map(h => (
                  <div key={h.id} className={`grid grid-cols-[100px_repeat(7,1fr)] gap-1 p-3 rounded-2xl border mb-2 items-center ${t.card}`}>
                    <div className="truncate font-bold text-xs">{h.title}</div>
                    {[...Array(7)].map((_, i) => {
                      const d = new Date(getWeekStart(currentDate)); d.setDate(d.getDate()+i);
                      const done = logs[`${h.id}-${getDateStr(d)}`];
                      return (
                        <div key={i} className="flex justify-center">
                          <div className={`w-6 h-6 rounded-lg flex items-center justify-center ${done ? `bg-gradient-to-br ${COLOR_THEMES[h.color].from} ${COLOR_THEMES[h.color].to} text-white` : 'bg-stone-100 dark:bg-slate-900'}`}>
                            {done && <Check size={12} strokeWidth={4}/>}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ))}
              </div>
            </div>
          )}

          {view === 'stats' && (
            <div className="space-y-4 pb-24">
              {habits.map(h => (
                <div key={h.id} className={`p-4 rounded-2xl border flex items-center justify-between ${t.card}`}>
                  <div className="flex items-center gap-3">
                    <div className={`p-2 rounded-lg bg-gradient-to-br ${COLOR_THEMES[h.color].from} ${COLOR_THEMES[h.color].to} text-white`}>
                      {React.cloneElement(ICONS[h.icon], {size:16})}
                    </div>
                    <span className="font-bold text-sm">{h.title}</span>
                  </div>
                  <div className="text-right">
                    <div className={`text-xl font-black ${COLOR_THEMES[h.color].text}`}>{getWeekProgress(h.id, new Date())}</div>
                    <div className="text-[8px] opacity-40 uppercase font-bold">本週達成</div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </main>

        {/* Floating Button */}
        <button onClick={() => setEditingHabit({})} className={`absolute bottom-6 right-0 w-14 h-14 rounded-2xl shadow-2xl flex items-center justify-center text-white bg-gradient-to-br ${t.accent} z-40 transition-transform active:scale-90 border-2 border-white/20`}>
          <Plus size={28} />
        </button>

        {/* Edit Modal */}
        {editingHabit && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm">
            <div className={`w-full max-w-xs p-6 rounded-3xl shadow-2xl ${t.card}`}>
              <div className="flex justify-between mb-6">
                <h3 className="text-lg font-black">編輯習慣</h3>
                <button onClick={() => setEditingHabit(null)}><X /></button>
              </div>
              <form onSubmit={e => {
                e.preventDefault();
                const d = new FormData(e.target);
                const item = { ...editingHabit, title: d.get('t'), goalPerWeek: +d.get('g'), unit: d.get('u'), icon: editingHabit.icon || 'Sparkles', color: editingHabit.color || 'cyan' };
                if(!item.id) item.id = Date.now().toString();
                setHabits(editingHabit.id ? habits.map(h => h.id === item.id ? item : h) : [...habits, item]);
                setEditingHabit(null);
              }} className="space-y-4">
                <input name="t" defaultValue={editingHabit.title} placeholder="習慣名稱" required className="w-full p-3 rounded-xl border bg-transparent outline-none focus:ring-2 ring-blue-500/20 font-bold" />
                <div className="flex gap-2">
                  <input name="g" type="number" defaultValue={editingHabit.goalPerWeek || 5} className="w-1/2 p-3 rounded-xl border bg-transparent font-bold" />
                  <input name="u" defaultValue={editingHabit.unit || '次'} className="w-1/2 p-3 rounded-xl border bg-transparent font-bold" />
                </div>
                <button className={`w-full py-3 rounded-xl text-white font-black bg-gradient-to-r ${t.accent}`}>儲存習慣</button>
              </form>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
